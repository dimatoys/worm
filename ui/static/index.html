<html>
	<head>
		<meta charset="utf-8">
		<title>Worm control</title>
		<link rel="stylesheet" href="/static/jquery-ui-1.11.4/jquery-ui.css">
		<script src="/static/jquery-1.11.3.min.js"></script>
		<script src="/static/jquery-ui-1.11.4/jquery-ui.min.js"></script>
		<script type="text/javascript">

function MotorControl(parent, channel, vmin, vmid, vmax, value) {
	
	var obj = {Channel: channel,

				inValueChange: false,

	           AngleToValue: function() {
					if(!this.inValueChange) {
						angle = parseFloat(this.angle_input.val())
						this.inValueChange = true
						this.slider.slider('value', angle);
						this.inValueChange = false

						this.SendAngle(function(data){
							obj.value_input.val(data["value"])
						})
					}
	           },

	           ValueToAngle: function() {
					value = parseFloat(this.value_input.val())
					vmid = parseFloat(this.mid_input.val())
					if (value >= vmid) {
						vmax = parseFloat(this.max_input.val())
						angle = 90 * (value - vmid) / (vmax-vmid)
					} else {
						vmin = parseFloat(this.min_input.val())
						angle = -90 * (vmid - value) / (vmid - vmin)
					}
					this.inValueChange = true
					this.slider.slider('value', angle);
					this.inValueChange = false
	            },

	            SendValue: function() {
					value = parseFloat(this.value_input.val())
					$.getJSON( "/setservovalue/" + this.Channel + "/" + value,
					  function( data ) {})
				},

	            SendAngle: function(callback) {
					angle = parseFloat(this.angle_input.val())
					$.getJSON( "/setservoangle/" + this.Channel + "/" + angle,
					  callback)
				},

				SendParams: function() {
					vmin = parseFloat(this.min_input.val())
					vmid = parseFloat(this.mid_input.val())
					vmax = parseFloat(this.max_input.val())
					$.getJSON( "/setservoparams/" + this.Channel + "/" + vmin + "/" + vmid + "/" + vmax,
					  function(){})
				}
		}
	
	top_row = $("<tr/>").appendTo($("<table/>").appendTo(parent))
	obj.slider = $("<div/>").css("height", "200px")
	                        .appendTo($("<td/>").appendTo(top_row))
	mtd = $("<td/>").appendTo(top_row)
	                .append($("<h3/>").css("text-align", "center")
	                                  .text("Channel " + channel))
	param_t = $("<table/>").appendTo(mtd)

	angle_row = $("<tr/>").appendTo(param_t)
	                      .append($("<td/>").text("Angle"))
	obj.angle_input = $("<input/>").appendTo($("<td/>").appendTo(angle_row))
	                           .attr("size", 4)
	$("<button/>").appendTo($("<td/>").appendTo(angle_row))
	              .text("Set")
	              .click(function(){
					  obj.AngleToValue()
	               })

	value_row = $("<tr/>").appendTo(param_t)
	                      .append($("<td/>").text("Value"))
	obj.value_input = $("<input/>").appendTo($("<td/>").appendTo(value_row))
	                           .attr("size", 4)
	                           .val(value)
	$("<button/>").appendTo($("<td/>").appendTo(value_row))
	              .text("Set")
	              .click(function(){
					  obj.ValueToAngle()
					  obj.SendValue()
	               })

	max_row = $("<tr/>").appendTo(param_t)
	                      .append($("<td/>").text("+90"))
	obj.max_input = $("<input/>").appendTo($("<td/>").appendTo(max_row))
	                           .attr("size", 4)
	                           .val(vmax)
	$("<button/>").appendTo($("<td/>").appendTo(max_row))
	              .text("Set")
	              .click(function(){
					  obj.ValueToAngle()
					  obj.SendParams()
	               })

	mid_row = $("<tr/>").appendTo(param_t)
	                      .append($("<td/>").text("0"))
	obj.mid_input = $("<input/>").appendTo($("<td/>").appendTo(mid_row))
	                           .attr("size", 4)
	                           .val(vmid)
	$("<button/>").appendTo($("<td/>").appendTo(mid_row))
	              .text("Set")
	              .click(function(){
					  obj.ValueToAngle()
					  obj.SendParams()
	               })

	min_row = $("<tr/>").appendTo(param_t)
	                      .append($("<td/>").text("-90"))
	obj.min_input = $("<input/>").appendTo($("<td/>").appendTo(min_row))
	                           .attr("size", 4)
	                           .val(vmin)
	$("<button/>").appendTo($("<td/>").appendTo(min_row))
	              .text("Set")
	              .click(function(){
					  obj.ValueToAngle()
					  obj.SendParams()
	               })
	
	obj.turn_button = $("<button/>").appendTo($("<p>").appendTo(mtd)
	                                              .css("text-align","center"))
	                            .text("ON")
	                            .css("width", "120px")

	obj.slider.slider({orientation: "vertical",
	                           min: -90,
	                           max: 90,
	                         value: 0,
	                        change: function( event, ui ) {
										obj.angle_input.val(ui.value)
										obj.AngleToValue()
									}
	})

	obj.ValueToAngle()

	return obj
}

function StepsControl(parent) {
	
	var sc = {steps: 0}
	
	parent.html("")
	$.getJSON( "worm/steps", function(data) {
		table = $("<table/>").appendTo(parent)
		sc.steps = 0
		$.each(data, function(i, step){
			var tr = $("<tr/>").appendTo(table)
			$("<td/>").text(i).appendTo(tr)
			$.each(step, function(j, motor){
				$("<input/>").val(motor)
							.appendTo($("<td/>").appendTo(tr))
			})
			$("<button/>").text("Move to")
						  .appendTo($("<td/>").appendTo(tr))
						  .click(function(){
							$.getJSON( "worm/moveto/" + i, function(data) {})
						  })
			sc.steps++;
		})
		$("#totalSteps").text(sc.steps)
	})

	return sc
}

var stepsControl = undefined

$(function() {
	$.getJSON( "/getservos" ,function( data ) {
		$.each(data, function(i, channel){
			parent = $("<td/>").appendTo("#motors")
			MotorControl(parent,
			             channel.channel,
			             channel.min,
			             channel.mid,
			             channel.max,
			             channel.value)
		})
	});
	stepsControl = StepsControl($("#steps"))
	$("#step").text(nextStep)

	$("#nextStep").click(function(){
		$.getJSON( "/worm/moveto/" + $("#step").val(), function(data) {
			nextStep = parseInt($("#step").val())  + 1
			if (nextStep >= stepsControl.steps) {
				nextStep = 0
			}
			$("#step").val(nextStep)
		})
	})

	$("#worm_stop").click(function(){
		$.getJSON( "/worm/setstate/stop", function(data) {})
	})

	$("#worm_forward").click(function(){
		$.getJSON( "/worm/setstate/forward", function(data) {})
	})

	$("#worm_backward").click(function(){
		$.getJSON( "/worm/setstate/backward", function(data) {})
	})

	$("#worm_update_pause_rate").click(function(){
		$.getJSON( "/worm/setrate/" + $("#worm_pause_rate").val(), function(data) {})
	})
})

$(document).ready(function() {
})
		</script>
	</head>
	<body>
		<h1>Worm control</h1>
		<table>
			<tr id="motors">
			</tr>
		</table>
		<h2>Steps</h2>
		<table>
			<tr>
				<td>
					<button id="nextStep">Next</button>
					<input id="step" value="0">/
					<span id="totalSteps">-</span>
				</td>
			</tr>
			<tr>
				<td>
					<button id="worm_stop">STOP</button>
					<button id="worm_forward">FORWARD</button>
					<button id="worm_backward">BACKWARD</button>
					<input id="worm_pause_rate" value="0.002">
					<button id="worm_update_pause_rate">UPDATE PAUSE RATE</button>
				</td>
			</tr>
		<table>
		<div id="steps"></div>
	</body>
</html>
