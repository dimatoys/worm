<html>
	<head>
		<meta charset="utf-8">
		<title>Worm control</title>
		<link rel="stylesheet" href="/static/jquery-ui-1.11.4/jquery-ui.css">
		<script src="/static/jquery-1.11.3.min.js"></script>
		<script src="/static/jquery-ui-1.11.4/jquery-ui.min.js"></script>
		<script type="text/javascript">

function MotorControl(parent, channel, vmin, vmid, vmax, value) {
	
	var obj = {Channel: channel,

				inValueChange: false,

	           AngleToValue: function() {
					if(!this.inValueChange) {
						angle = parseFloat(this.angle_input.val())
						this.inValueChange = true
						this.slider.slider('value', angle);
						this.inValueChange = false

						this.SendAngle(function(data){
							obj.value_input.val(data["value"])
						})
					}
	           },

	           ValueToAngle: function() {
					value = parseFloat(this.value_input.val())
					vmid = parseFloat(this.mid_input.val())
					if (value >= vmid) {
						vmax = parseFloat(this.max_input.val())
						angle = 90 * (value - vmid) / (vmax-vmid)
					} else {
						vmin = parseFloat(this.min_input.val())
						angle = -90 * (vmid - value) / (vmid - vmin)
					}
					this.inValueChange = true
					this.slider.slider('value', angle);
					this.inValueChange = false
	            },

	            SendValue: function() {
					value = parseFloat(this.value_input.val())
					$.getJSON( "/setservovalue/" + this.Channel + "/" + value,
					  function( data ) {})
					if (value == 0) {
						obj.turn_button.text("ON")
					} else {
						obj.turn_button.text("OFF")
					}
				},

	            SendAngle: function(callback) {
					angle = parseFloat(this.angle_input.val())
					$.getJSON( "/setservoangle/" + this.Channel + "/" + angle,
					  callback)
					obj.turn_button.text("OFF")
				},

				SendParams: function() {
					vmin = parseFloat(this.min_input.val())
					vmid = parseFloat(this.mid_input.val())
					vmax = parseFloat(this.max_input.val())
					$.getJSON( "/setservoparams/" + this.Channel + "/" + vmin + "/" + vmid + "/" + vmax,
					  function(){})
				},

				Refresh: function(data){
					console.log(data)
					obj.inValueChange = true
					obj.slider.slider('value', data.angle);
					obj.inValueChange = false
					obj.value_input.val(data.value)
					this.min_input.val(data.min)
					this.mid_input.val(data.mid)
					this.max_input.val(data.max)
				}
		}
	
	top_row = $("<tr/>").appendTo($("<table/>").appendTo(parent))
	obj.slider = $("<div/>").css("height", "200px")
	                        .appendTo($("<td/>").appendTo(top_row))
	mtd = $("<td/>").appendTo(top_row)
	                .append($("<h3/>").css("text-align", "center")
	                                  .text("Channel " + channel))
	param_t = $("<table/>").appendTo(mtd)

	angle_row = $("<tr/>").appendTo(param_t)
	                      .append($("<td/>").text("Angle"))
	obj.angle_input = $("<input/>").appendTo($("<td/>").appendTo(angle_row))
	                           .attr("size", 4)
	$("<button/>").appendTo($("<td/>").appendTo(angle_row))
	              .text("Set")
	              .click(function(){
					  obj.AngleToValue()
	               })

	value_row = $("<tr/>").appendTo(param_t)
	                      .append($("<td/>").text("Value"))
	obj.value_input = $("<input/>").appendTo($("<td/>").appendTo(value_row))
	                           .attr("size", 4)
	                           .val(value)
	$("<button/>").appendTo($("<td/>").appendTo(value_row))
	              .text("Set")
	              .click(function(){
					  obj.ValueToAngle()
					  obj.SendValue()
	               })

	max_row = $("<tr/>").appendTo(param_t)
	                      .append($("<td/>").text("+90"))
	obj.max_input = $("<input/>").appendTo($("<td/>").appendTo(max_row))
	                           .attr("size", 4)
	                           .val(vmax)
	$("<button/>").appendTo($("<td/>").appendTo(max_row))
	              .text("Set")
	              .click(function(){
					  obj.ValueToAngle()
					  obj.SendParams()
	               })

	mid_row = $("<tr/>").appendTo(param_t)
	                      .append($("<td/>").text("0"))
	obj.mid_input = $("<input/>").appendTo($("<td/>").appendTo(mid_row))
	                           .attr("size", 4)
	                           .val(vmid)
	$("<button/>").appendTo($("<td/>").appendTo(mid_row))
	              .text("Set")
	              .click(function(){
					  obj.ValueToAngle()
					  obj.SendParams()
	               })

	min_row = $("<tr/>").appendTo(param_t)
	                      .append($("<td/>").text("-90"))
	obj.min_input = $("<input/>").appendTo($("<td/>").appendTo(min_row))
	                           .attr("size", 4)
	                           .val(vmin)
	$("<button/>").appendTo($("<td/>").appendTo(min_row))
	              .text("Set")
	              .click(function(){
					  obj.ValueToAngle()
					  obj.SendParams()
	               })
	
	obj.turn_button = $("<button/>").appendTo($("<p>").appendTo(mtd)
	                                              .css("text-align","center"))
	                            .text("ON")
	                            .css("width", "120px")
	                            .click(function(){
									obj.value_input.val(0)
									obj.SendValue()
								})

	obj.slider.slider({orientation: "vertical",
	                           min: -90,
	                           max: 90,
	                         value: 0,
	                        change: function( event, ui ) {
										obj.angle_input.val(ui.value)
										obj.AngleToValue()
									}
	})

	obj.ValueToAngle()

	return obj
}

function StepsControl(parent) {
	
	var sc = {steps: 0}
	
	parent.html("")
	$.getJSON( "worm/steps", function(data) {
		table = $("<table/>").appendTo(parent)
		sc.steps = 0
		$.each(data, function(i, step){
			var tr = $("<tr/>").appendTo(table)
			$("<td/>").text(i).appendTo(tr)
			$.each(step, function(j, motor){
				$("<input/>").val(motor)
							.appendTo($("<td/>").appendTo(tr))
			})
			$("<button/>").text("Move to")
						  .appendTo($("<td/>").appendTo(tr))
						  .click(function(){
							$.getJSON( "worm/moveto/" + i, function(data) {})
						  })
			sc.steps++;
		})
		$("#totalSteps").text(sc.steps)
	})

	return sc
}

function AngleControl(parent, vmin, vmax, vdef, stepInput, name) {
	var obj = {
		StepInput: stepInput,
		Name: name,
		SendValue: function(){
			$.getJSON( "/worm/control/" + obj.Name + "/" + obj.value.val(), function(data) {})
		}
	}

	obj.slider = $("<div/>").css("width", "200px").appendTo(parent)
	obj.value  = $("<input/>").val(vdef).appendTo(parent)
	obj.button = $("<button/>").html("Set")
							   .appendTo(parent)
	                           .click(function(){
									obj.slider.slider('value', obj.value.val());
								})

	obj.slider.slider({orientation: "horizontal",
	                           min: parseFloat(vmin),
	                           max: parseFloat(vmax),
	                         value: parseFloat(vdef),
	                        change: function( event, ui ) {
										obj.value.val(ui.value)
										obj.StepInput.val(obj.Name)
										obj.SendValue()
									}
	})
	                        
	return obj
}

var stepsControl = undefined
var wormStates = undefined
var motors = undefined

function refresh_motors(){
	$.getJSON( "/getservos" ,function( data ) {
		$.each(data, function(i, channel){
			motors[i].Refresh(channel)
		})
	})
}

function getCurrentStepIdx(){
	step = $("#step").val()
	step_idx = -1
	for(var i = 0; i < wormStates.length;++i){
		if (step == wormStates[i]) {
			step_idx = i
			break
		}
	}
	return step_idx
}

$(function() {
	$.getJSON( "/getservos" ,function( data ) {
		motors = []
		$.each(data, function(i, channel){
			parent = $("<td/>").appendTo("#motors")
			motors.push(MotorControl(parent,
			                         channel.channel,
			                         channel.min,
			                         channel.mid,
			                         channel.max,
			                         channel.value))
		})
	});

	$("#servos_refresh").click(refresh_motors)

	$("#worm_stop").click(function(){
		$.getJSON( "/worm/setstate/stop", function(data) {})
	})

	$("#worm_forward").click(function(){
		$.getJSON( "/worm/setstate/forward", function(data) {})
	})

	$("#worm_backward").click(function(){
		$.getJSON( "/worm/setstate/backward", function(data) {})
	})

	$("#worm_update_pause_rate").click(function(){
		$.getJSON( "/worm/setrate/" + $("#worm_pause_rate").val(), function(data) {})
	})

	$("#worm_mouth_open").click(function(){
		$.getJSON( "/worm/mouth/open", function(data) {})
	})

	$("#worm_mouth_close").click(function(){
		$.getJSON( "/worm/mouth/close", function(data) {})
	})

	$.getJSON( "/worm/getcontrolstates" ,function( data ) {
		var minmax = 100000
		wormStates = []
		$.each(data, function(id, step){
			var name = step.name
			stepmax = parseFloat(step.max)
			if (stepmax > 0 && stepmax < minmax) {
				minmax = stepmax
			}
			wormStates.push(name)
		})
		$("#stepsize_slider").slider({orientation: "horizontal",
	                           min: 0,
	                           max: minmax,
	                         value: 0,
	                        change: function( event, ui ) {
										$("#stepsize").val(ui.value)
										$.getJSON( "/worm/stepsize/" + ui.value, refresh_motors)
									}
		})
		$("#set_stepsize").click(function(){
			$("#stepsize_slider").slider('value', $("#stepsize").val());
		})
		$("#turn_slider").slider({orientation: "horizontal",
	                           min: -90,
	                           max: 90,
	                         value: 0,
	                        change: function( event, ui ) {
										$("#turn").val(ui.value)
										$.getJSON( "/worm/turn/" + ui.value, refresh_motors)
									}
		})
		$("#set_turn").click(function(){
			$("#stepsize_turn").slider('value', $("#turn").val());
		})
	})

	$("#nextStep").click(function(){
		step_idx = getCurrentStepIdx()
		if (step_idx >= 0){
			$.getJSON( "/worm/control/" + wormStates[step_idx], refresh_motors)
			++step_idx
			if (step_idx >= wormStates.length) {
				step_idx = 0
			}
		} else {
			step_idx = 0
		}
		$("#step").val(wormStates[step_idx])
	})

	$("#prevStep").click(function(){
		step_idx = getCurrentStepIdx()
		if (step_idx >= 0){
			--step_idx
			if (step_idx < 0) {
				step_idx = wormStates.length - 1
			}
			$.getJSON( "/worm/control/" + wormStates[step_idx], refresh_motors)
		} else {
			step_idx = 0
		}
		$("#step").val(wormStates[step_idx])
	})

})

$(document).ready(function() {
})
		</script>
	</head>
	<body>
		<h1>Worm control</h1>
		<button id="servos_refresh">REFRESH</button>
		<table>
			<tr id="motors">
			</tr>
		</table>
		<h2>Steps</h2>
		<table border=2>
			<tr>
				<td>Mouth control</td>
				<td>
					<button id="worm_mouth_open">OPEN</button>
					<button id="worm_mouth_close">CLOSE</button>
				</td>
			</tr>
			<tr>
				<td>Movement control</tdtd>
				<td>
					<button id="worm_stop">STOP</button>
					<button id="worm_forward">FORWARD</button>
					<button id="worm_backward">BACKWARD</button>
					<input id="worm_pause_rate" value="0.002">
					<button id="worm_update_pause_rate">UPDATE PAUSE RATE</button>
				</td>
			</tr>
			<tr>
				<td>Steps control</tdtd>
				<td>
					<button id="prevStep">Prev</button>
					<input id="step" value="0">
					<button id="nextStep">Next</button>
				</td>
			</tr>
			<tr>
				<td>Step size</td>>
				<td>
					<div id="stepsize_slider"></div>
					<input id="stepsize" value="0">
					<button id="set_stepsize">Set</button>
				</td>
			</tr>
			<tr>
				<td>Turn</td>
				<td>
					<div id="turn_slider"></div>
					<input id="turn" value="0">
					<button id="set_turn">Set</button>
				</td>
			</tr>
		<table>
	</body>
</html>
